<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìä Sistema de Asistencia - ISIS2007</title>
    
    <!-- Configuraci√≥n de Airtable -->
    <script src="airtable-config.js"></script>
    <script src="airtable-service.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding-top: 80px;
        }

        /* Barra de Navegaci√≥n */
        .nav-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 15px 20px;
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .nav-brand {
            font-size: 1.2rem;
            font-weight: 600;
            color: #2c3e50;
            text-decoration: none;
        }

        .nav-brand:hover {
            color: #667eea;
        }

        .nav-links {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .nav-link {
            color: #7f8c8d;
            text-decoration: none;
            font-size: 0.9rem;
            font-weight: 500;
            transition: color 0.3s ease;
            padding: 8px 12px;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .nav-link:hover {
            color: #667eea;
            background: rgba(102, 126, 234, 0.1);
        }

        .nav-link.active {
            color: #667eea;
            background: rgba(102, 126, 234, 0.1);
        }

        .home-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            text-decoration: none;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }

        .home-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 20px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        .header h1 {
            color: #2c3e50;
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header h2 {
            color: #7f8c8d;
            font-size: 1.3rem;
            font-weight: 400;
        }

        /* Login Section */
        .login-section {
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 20px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            text-align: center;
        }

        .login-form {
            max-width: 400px;
            margin: 0 auto;
        }

        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #2c3e50;
            font-weight: 600;
        }

        .form-group input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .login-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 16px rgba(102, 126, 234, 0.3);
            width: 100%;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        /* Attendance Section */
        .attendance-section {
            display: none;
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 20px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        .attendance-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .date-selector {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .date-input {
            padding: 10px 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 1rem;
        }

        .attendance-btn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .attendance-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
        }

        .sync-btn {
            background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-left: 10px;
        }

        .sync-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(33, 150, 243, 0.3);
        }

        .test-btn {
            background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-left: 10px;
        }

        .test-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(255, 152, 0, 0.3);
        }

        .logout-btn {
            background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3);
        }

        .students-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .student-card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .student-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .student-card.present {
            border-color: #28a745;
            background: linear-gradient(135deg, rgba(40, 167, 69, 0.1) 0%, rgba(32, 201, 151, 0.1) 100%);
        }

        .student-card.absent {
            border-color: #dc3545;
            background: linear-gradient(135deg, rgba(220, 53, 69, 0.1) 0%, rgba(253, 126, 20, 0.1) 100%);
        }

        .student-name {
            font-size: 1.1rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 8px;
        }

        .student-status {
            font-size: 0.9rem;
            color: #7f8c8d;
        }

        .status-present {
            color: #28a745;
            font-weight: 600;
        }

        .status-absent {
            color: #dc3545;
            font-weight: 600;
        }

        /* Statistics Section */
        .stats-section {
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 20px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            border: 2px solid #e9ecef;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #7f8c8d;
            font-size: 0.9rem;
        }

        .attendance-history {
            margin-top: 25px;
        }

        .history-title {
            color: #2c3e50;
            font-size: 1.3rem;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .history-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        }

        .history-table th {
            background: #f8f9fa;
            padding: 15px;
            text-align: left;
            color: #2c3e50;
            font-weight: 600;
        }

        .history-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #e9ecef;
        }

        .history-table tr:hover {
            background: #f8f9fa;
        }

        .export-btn {
            background: linear-gradient(135deg, #17a2b8 0%, #6f42c1 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 15px;
        }

        .export-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(23, 162, 184, 0.3);
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 1px solid #f5c6cb;
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 1px solid #c3e6cb;
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .students-grid {
                grid-template-columns: 1fr;
            }
            
            .attendance-header {
                flex-direction: column;
                align-items: stretch;
            }
            
            .date-selector {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <!-- üîê Cargar configuraci√≥n segura -->
    <script src="config.js"></script>
    <!-- Barra de Navegaci√≥n -->
    <div class="nav-bar">
        <a href="index.html" class="nav-brand">üöÄ ISIS2007</a>
        <div class="nav-links">
            <a href="team.html" class="nav-link">üë• Equipo</a>
            <a href="schedule.html" class="nav-link">üìÖ Cronograma</a>
            <a href="ruleta-estudiantes.html" class="nav-link">üéØ Ruleta</a>
            <a href="asistencia.html" class="nav-link active">üìä Asistencia</a>
            <a href="index.html" class="home-button">üè† Inicio</a>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <h1>üìä Sistema de Asistencia</h1>
            <h2>ISIS2007 - Dise√±o de Productos e Innovaci√≥n en TI</h2>
        </div>

        <!-- Login Section -->
        <div class="login-section" id="loginSection">
            <h3>üîê Acceso de Profesores y Monitores</h3>
            <div class="login-form">
                <div class="form-group">
                    <label for="username">Usuario:</label>
                    <input type="text" id="username" placeholder="Ingresa tu usuario">
                </div>
                <div class="form-group">
                    <label for="password">Contrase√±a:</label>
                    <input type="password" id="password" placeholder="Ingresa tu contrase√±a">
                </div>
                <button class="login-btn" onclick="login()">üîë Iniciar Sesi√≥n</button>
                <div id="loginMessage"></div>
            </div>
        </div>

        <!-- Attendance Section -->
        <div class="attendance-section" id="attendanceSection">
            <div class="attendance-header">
                <div class="date-selector">
                    <label for="attendanceDate">Fecha:</label>
                    <input type="date" id="attendanceDate" class="date-input">
                    <button class="attendance-btn" onclick="saveAttendance()">üíæ Guardar Asistencia</button>
                    <button class="sync-btn" onclick="syncWithAirtable()">üîÑ Sincronizar Airtable</button>
                    <button class="test-btn" onclick="testAirtableConnection()">üîó Probar Conexi√≥n</button>
                </div>
                <button class="logout-btn" onclick="logout()">üö™ Cerrar Sesi√≥n</button>
            </div>

            <div class="students-grid" id="studentsGrid">
                <!-- Students will be loaded here -->
            </div>

            <div class="stats-section">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="totalStudents">0</div>
                        <div class="stat-label">Total Estudiantes</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="presentStudents">0</div>
                        <div class="stat-label">Presentes</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="absentStudents">0</div>
                        <div class="stat-label">Ausentes</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="attendanceRate">0%</div>
                        <div class="stat-label">Tasa de Asistencia</div>
                    </div>
                </div>

                <div class="attendance-history">
                    <h3 class="history-title">üìà Historial de Asistencia</h3>
                    <table class="history-table" id="historyTable">
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Presentes</th>
                                <th>Ausentes</th>
                                <th>Tasa</th>
                                <th>Registrado por</th>
                            </tr>
                        </thead>
                        <tbody id="historyBody">
                            <!-- History will be loaded here -->
                        </tbody>
                    </table>
                    <button class="export-btn" onclick="exportData()">üì• Exportar Datos</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Lista de estudiantes del curso
        const students = [
            'Alcala Gonzalez, Sofia',
            'Aristizabal Garcia, Gabriel',
            'Avila Nivia, Juan Sebastian',
            'Benavides Rocha, Diego Juan Vicente',
            'Botero Ruiz, Andres',
            'Brice√±o Estupi√±an, David Alejandro',
            'Brice√±o Toro, Juan Eduardo',
            'Carrillo, Maria Alejandra',
            'Castellanos Ribero, Pablo',
            'Castro, Anais Maria',
            'Cespedes Cortes, Yefran David',
            'Cuervo Ortiz, Juan David',
            'Davila Betancourt, Andrea',
            'Diez Leal, Samuel',
            'Escobar Pineda, Samuel Alejandro',
            'Franco Pardo, Yhojan Alejandro',
            'Garrido Arroyo, Esteban',
            'Gonzalez Bermudez, Julian David',
            'Guiza Melo, Laura Valentina',
            'Hernandez Paez, Juan Felipe',
            'Jimenez Tovar, Laura Valentina',
            'Leschhorn, Martin',
            'Maldonado Manrique, Juan Sebastian',
            'Mu√±oz Estevez, Laura Valentina',
            'Ni√±o Mendez, Joel David',
            'Ochoa Bejarano, Juan Felipe',
            'Pereira Avila, Andres Felipe',
            'Perez Diaz, Juan David',
            'Pineda Cano, Jeronimo Arnulfo',
            'Pinto, Julian Rafael',
            'Polania Arias, Angie Katherine',
            'Quiroz Pintor, Santiago Alberto',
            'Ramirez Aleman, Julian Roberto',
            'Reyes Romero, Juan Pablo',
            'Rodriguez Pinto, Gabriel Enrique',
            'Roncancio Camacho, Juan David',
            'Ross Aguirre, Joshua John',
            'Sanabria Salazar, Maria Alejandra',
            'Sanmiguel Losada, Felipe',
            'Sarmiento Gutierrez, Laura Sofia',
            'Serrano Arango, Amelia',
            'Velasquez Delgado, Tomas Emilio',
            'Vides Vivero, Alejandro Enrique',
            'Zambrano Burbano, Mateo'
        ];

                    // üîê CONFIGURACI√ìN SEGURA - Cargar desde config.js
        const users = window.CONFIG ? window.CONFIG.USERS : {
            'prof.arturo.gomez': { password: 'Arturo2025#Uniandes$Profesor!', role: 'Profesor Principal' },
            'monitor.juanes.rodriguez': { password: 'Juanes2025#Monitor$Uniandes!', role: 'Monitor' },
            'monitor.catalina.martinez': { password: 'Catalina2025#Monitor$Uniandes!', role: 'Monitor' }
        };

        let currentUser = null;
        let attendanceData = {};
        let currentDate = new Date().toISOString().split('T')[0];

        // Inicializar
        document.addEventListener('DOMContentLoaded', function() {
            loadAttendanceData();
            document.getElementById('attendanceDate').value = currentDate;
            createStudentCards();
        });

        // Funci√≥n de login
        function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const messageDiv = document.getElementById('loginMessage');

            if (users[username] && users[username].password === password) {
                currentUser = { username, role: users[username].role };
                document.getElementById('loginSection').style.display = 'none';
                document.getElementById('attendanceSection').style.display = 'block';
                messageDiv.innerHTML = '<div class="success-message">‚úÖ Acceso exitoso. Bienvenido, ' + currentUser.role + '</div>';
            } else {
                messageDiv.innerHTML = '<div class="error-message">‚ùå Usuario o contrase√±a incorrectos</div>';
            }
        }

        // Funci√≥n de logout
        function logout() {
            currentUser = null;
            document.getElementById('loginSection').style.display = 'block';
            document.getElementById('attendanceSection').style.display = 'none';
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            document.getElementById('loginMessage').innerHTML = '';
        }

        // Crear tarjetas de estudiantes
        function createStudentCards() {
            const grid = document.getElementById('studentsGrid');
            grid.innerHTML = '';

            students.forEach(student => {
                const card = document.createElement('div');
                card.className = 'student-card';
                card.onclick = () => toggleAttendance(student, card);
                
                const status = getStudentStatus(student, currentDate);
                if (status === 'present') {
                    card.classList.add('present');
                } else if (status === 'absent') {
                    card.classList.add('absent');
                }

                card.innerHTML = `
                    <div class="student-name">${student}</div>
                    <div class="student-status ${status ? 'status-' + status : ''}">
                        ${status ? (status === 'present' ? '‚úÖ Presente' : '‚ùå Ausente') : '‚è≥ Sin registrar'}
                    </div>
                `;
                
                grid.appendChild(card);
            });
        }

        // Alternar asistencia
        function toggleAttendance(student, card) {
            const currentStatus = getStudentStatus(student, currentDate);
            let newStatus;

            if (currentStatus === 'present') {
                newStatus = 'absent';
                card.classList.remove('present');
                card.classList.add('absent');
            } else {
                newStatus = 'present';
                card.classList.remove('absent');
                card.classList.add('present');
            }

            // Guardar en localStorage
            if (!attendanceData[currentDate]) {
                attendanceData[currentDate] = {};
            }
            attendanceData[currentDate][student] = newStatus;
            localStorage.setItem('attendanceData', JSON.stringify(attendanceData));

            // Actualizar estado visual
            const statusDiv = card.querySelector('.student-status');
            statusDiv.className = `student-status status-${newStatus}`;
            statusDiv.textContent = newStatus === 'present' ? '‚úÖ Presente' : '‚ùå Ausente';

            updateStats();
        }

        // Obtener estado del estudiante
        function getStudentStatus(student, date) {
            if (attendanceData[date] && attendanceData[date][student]) {
                return attendanceData[date][student];
            }
            return null;
        }

        // Guardar asistencia
        async function saveAttendance() {
            const date = document.getElementById('attendanceDate').value;
            if (!attendanceData[date]) {
                attendanceData[date] = {};
            }

            // Marcar todos los no registrados como ausentes
            students.forEach(student => {
                if (!attendanceData[date][student]) {
                    attendanceData[date][student] = 'absent';
                }
            });

            // Guardar registro de la sesi√≥n
            if (!attendanceData[date]._session) {
                attendanceData[date]._session = {
                    user: currentUser.username,
                    role: currentUser.role,
                    timestamp: new Date().toISOString()
                };
            }

            localStorage.setItem('attendanceData', JSON.stringify(attendanceData));
            
            // Sincronizar con Airtable si est√° configurado
            if (AIRTABLE_CONFIG.API_KEY !== 'YOUR_AIRTABLE_API_KEY') {
                try {
                    showLoadingMessage('üîÑ Sincronizando con Airtable...');
                    
                    const syncResults = await airtableService.syncWithAirtable(attendanceData);
                    
                    if (syncResults.success > 0) {
                        showSuccessMessage(`‚úÖ Sincronizado con Airtable: ${syncResults.success} registros`);
                    } else if (syncResults.errors > 0) {
                        showErrorMessage(`‚ö†Ô∏è Errores en sincronizaci√≥n: ${syncResults.errors} errores`);
                    }
                } catch (error) {
                    console.error('Error al sincronizar con Airtable:', error);
                    showErrorMessage('‚ùå Error al sincronizar con Airtable');
                }
            }
            
            // Mostrar mensaje de √©xito
            const messageDiv = document.createElement('div');
            messageDiv.className = 'success-message';
            messageDiv.textContent = '‚úÖ Asistencia guardada exitosamente';
            document.getElementById('attendanceSection').insertBefore(messageDiv, document.getElementById('attendanceSection').firstChild);
            
            setTimeout(() => messageDiv.remove(), 3000);
            
            updateStats();
            loadHistory();
        }

        // Funci√≥n para mostrar mensaje de carga
        function showLoadingMessage(message) {
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'loading-message';
            loadingDiv.innerHTML = `
                <div style="
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: rgba(0, 0, 0, 0.8);
                    color: white;
                    padding: 20px;
                    border-radius: 10px;
                    z-index: 10000;
                    font-size: 16px;
                ">
                    ${message}
                </div>
            `;
            document.body.appendChild(loadingDiv);
        }

        // Funci√≥n para mostrar mensaje de √©xito
        function showSuccessMessage(message) {
            const successDiv = document.createElement('div');
            successDiv.innerHTML = `
                <div style="
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: #4CAF50;
                    color: white;
                    padding: 15px;
                    border-radius: 8px;
                    z-index: 10000;
                    font-size: 14px;
                    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
                ">
                    ${message}
                </div>
            `;
            document.body.appendChild(successDiv);
            setTimeout(() => successDiv.remove(), 3000);
        }

        // Funci√≥n para mostrar mensaje de error
        function showErrorMessage(message) {
            const errorDiv = document.createElement('div');
            errorDiv.innerHTML = `
                <div style="
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: #f44336;
                    color: white;
                    padding: 15px;
                    border-radius: 8px;
                    z-index: 10000;
                    font-size: 14px;
                    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
                ">
                    ${message}
                </div>
            `;
            document.body.appendChild(errorDiv);
            setTimeout(() => errorDiv.remove(), 5000);
        }

        // Funci√≥n para sincronizar con Airtable
        async function syncWithAirtable() {
            if (AIRTABLE_CONFIG.API_KEY === 'YOUR_AIRTABLE_API_KEY') {
                showErrorMessage('‚ùå Configura Airtable primero en airtable-config.js');
                return;
            }

            try {
                showLoadingMessage('üîÑ Sincronizando con Airtable...');
                
                const syncResults = await airtableService.syncWithAirtable(attendanceData);
                
                // Remover mensaje de carga
                const loadingDiv = document.getElementById('loading-message');
                if (loadingDiv) loadingDiv.remove();
                
                if (syncResults.success > 0) {
                    showSuccessMessage(`‚úÖ Sincronizado: ${syncResults.success} registros enviados a Airtable`);
                } else if (syncResults.errors > 0) {
                    showErrorMessage(`‚ö†Ô∏è Errores: ${syncResults.errors} registros fallaron`);
                } else {
                    showSuccessMessage('‚úÖ No hay datos nuevos para sincronizar');
                }
            } catch (error) {
                console.error('Error al sincronizar con Airtable:', error);
                showErrorMessage('‚ùå Error de conexi√≥n con Airtable');
                
                // Remover mensaje de carga
                const loadingDiv = document.getElementById('loading-message');
                if (loadingDiv) loadingDiv.remove();
            }
        }

        // Funci√≥n para probar conexi√≥n con Airtable
        async function testAirtableConnection() {
            if (AIRTABLE_CONFIG.API_KEY === 'YOUR_AIRTABLE_API_KEY') {
                showErrorMessage('‚ùå Configura Airtable primero en airtable-config.js');
                return;
            }

            try {
                showLoadingMessage('üîó Probando conexi√≥n con Airtable...');
                
                const isConnected = await airtableService.testConnection();
                
                // Remover mensaje de carga
                const loadingDiv = document.getElementById('loading-message');
                if (loadingDiv) loadingDiv.remove();
                
                if (isConnected) {
                    showSuccessMessage('‚úÖ Conexi√≥n con Airtable exitosa');
                } else {
                    showErrorMessage('‚ùå Error de conexi√≥n con Airtable');
                }
            } catch (error) {
                console.error('Error al probar conexi√≥n:', error);
                showErrorMessage('‚ùå Error de conexi√≥n con Airtable');
                
                // Remover mensaje de carga
                const loadingDiv = document.getElementById('loading-message');
                if (loadingDiv) loadingDiv.remove();
            }
        }

        // Actualizar estad√≠sticas
        function updateStats() {
            const date = document.getElementById('attendanceDate').value;
            const present = students.filter(s => getStudentStatus(s, date) === 'present').length;
            const absent = students.filter(s => getStudentStatus(s, date) === 'absent').length;
            const total = students.length;
            const rate = total > 0 ? Math.round((present / total) * 100) : 0;

            document.getElementById('totalStudents').textContent = total;
            document.getElementById('presentStudents').textContent = present;
            document.getElementById('absentStudents').textContent = absent;
            document.getElementById('attendanceRate').textContent = rate + '%';
        }

        // Cargar datos de asistencia
        function loadAttendanceData() {
            const saved = localStorage.getItem('attendanceData');
            if (saved) {
                attendanceData = JSON.parse(saved);
            }
        }

        // Cargar historial
        function loadHistory() {
            const tbody = document.getElementById('historyBody');
            tbody.innerHTML = '';

            const dates = Object.keys(attendanceData).filter(date => date !== '_session').sort().reverse();

            dates.forEach(date => {
                const session = attendanceData[date]._session;
                const present = students.filter(s => getStudentStatus(s, date) === 'present').length;
                const absent = students.filter(s => getStudentStatus(s, date) === 'absent').length;
                const total = students.length;
                const rate = total > 0 ? Math.round((present / total) * 100) : 0;

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${formatDate(date)}</td>
                    <td>${present}</td>
                    <td>${absent}</td>
                    <td>${rate}%</td>
                    <td>${session ? session.role + ' (' + session.user + ')' : 'N/A'}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // Formatear fecha
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('es-ES', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }

        // Exportar datos
        function exportData() {
            const data = {
                course: 'ISIS2007 - Dise√±o de Productos e Innovaci√≥n en TI',
                semester: '2025-2',
                students: students,
                attendance: attendanceData,
                exportDate: new Date().toISOString()
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `asistencia-isis2007-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Actualizar cuando cambie la fecha
        document.getElementById('attendanceDate').addEventListener('change', function() {
            currentDate = this.value;
            createStudentCards();
            updateStats();
        });

        // Cargar historial al inicio
        loadHistory();
    </script>
</body>
</html> 